#include "esp_camera.h"
#include <WebServer.h>

WebServer server(80);

// Hàm trả về ảnh chụp JPEG
void handle_jpg() {
  camera_fb_t * fb = esp_camera_fb_get();
  if (!fb) {
    server.send(500, "text/plain", "Camera capture failed");
    return;
  }

  server.sendHeader("Content-Type", "image/jpeg");
  server.sendHeader("Content-Length", String(fb->len));
  server.send(200, "image/jpeg", "");

  WiFiClient client = server.client();
  client.write(fb->buf, fb->len);

  esp_camera_fb_return(fb);
}

// Giao diện web + server
void startCameraServer() {

  server.on("/", HTTP_GET, []() {
    server.send(200, "text/html",
      "<html><body><h1>ESP32-S3 Camera</h1>"
      "<img src='/jpg' />"
      "</body></html>");
  });

  server.on("/jpg", HTTP_GET, handle_jpg);

  server.begin();
  Serial.println("Camera server started on port 80");
}
